<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDS v4.2 - Emoji Field Demo (with Save/Load)</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: #0e0f12;
      color: #eee;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .mds-entity {
      position: absolute;
      font-size: 40px;
      user-select: none;
      will-change: transform, opacity, filter;
      transition: filter 0.2s ease;
      cursor: pointer;
    }

    .mds-field {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(255, 200, 100, 0.2) 0%,
        rgba(255, 200, 100, 0.05) 50%,
        transparent 100%
      );
      pointer-events: none;
      animation: field-pulse 2s ease-in-out infinite;
    }

    @keyframes field-pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .info {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 13px;
      line-height: 1.5;
      background: rgba(0, 0, 0, 0.75);
      padding: 14px;
      border-radius: 8px;
      max-width: 280px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(100, 255, 218, 0.2);
    }

    .info h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #64ffda;
    }

    .info p {
      margin: 6px 0;
      color: #ccc;
      font-size: 12px;
    }

    .info code {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
    }

    .debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.75);
      padding: 14px;
      border-radius: 8px;
      font-size: 12px;
      min-width: 180px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(100, 255, 218, 0.2);
    }

    .debug-panel h3 {
      margin: 0 0 10px;
      font-size: 14px;
      color: #64ffda;
    }

    .debug-stat {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      color: #ccc;
    }

    .debug-stat .label {
      color: #999;
    }

    .debug-stat .value {
      color: #64ffda;
      font-weight: 600;
    }

    .emoji-bubble {
      position: absolute;
      pointer-events: none;
      animation: bubble-float 3s ease-out forwards;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 14px;
      border-radius: 16px;
      font-size: 13px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      max-width: 200px;
      text-align: center;
      z-index: 100;
    }

    @keyframes bubble-float {
      0% {
        opacity: 0;
        transform: translateY(0) translateX(-50%) scale(0.8);
      }
      10% {
        opacity: 1;
        transform: translateY(-8px) translateX(-50%) scale(1.02);
      }
      80% {
        opacity: 1;
        transform: translateY(-35px) translateX(-50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) translateX(-50%) scale(0.9);
      }
    }

    /* NEW: Lifecycle Log Panel */
    .lifecycle-log {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.85);
      padding: 12px;
      border-radius: 8px;
      max-width: 350px;
      backdrop-filter: blur(8px);
      border: 1px solid rgba(100, 255, 218, 0.2);
    }

    .lifecycle-log h3 {
      margin: 0 0 8px;
      font-size: 13px;
      color: #64ffda;
    }

    .lifecycle-log .log-entry {
      font-size: 11px;
      color: #aaa;
      margin: 4px 0;
      font-family: 'Courier New', monospace;
      line-height: 1.4;
    }

    .lifecycle-log .log-entry.spawn { color: #4ade80; }
    .lifecycle-log .log-entry.update { color: #60a5fa; }
    .lifecycle-log .log-entry.destroy { color: #f87171; }

    /* NEW: Control Buttons */
    .controls {
      position: fixed;
      bottom: 20px;
      right: 20px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      max-width: 200px;
    }

    .btn {
      background: rgba(100, 255, 218, 0.15);
      border: 1px solid rgba(100, 255, 218, 0.4);
      color: #64ffda;
      padding: 8px 14px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(8px);
      font-weight: 500;
      white-space: nowrap;
    }

    .btn:hover {
      background: rgba(100, 255, 218, 0.25);
      border-color: #64ffda;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(100, 255, 218, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.active {
      background: rgba(100, 255, 218, 0.3);
      border-color: #64ffda;
    }
  </style>
</head>
<body>
  <div class="info">
    <h2>üåå MDS v4.2 Demo A</h2>
    <p><strong>Emoji Field + Lifecycle</strong></p>
    <p>üíå Shy paper - Hover 3x to hide</p>
    <p>üê• Curious paper - Leans in</p>
    <p>‚ú® Trust field spawns when close</p>
    <p>üíæ <strong>NEW:</strong> Save/Load state</p>
    <p>üé≤ <strong>NEW:</strong> Seed mode (deterministic)</p>
    <p>üîí <strong>NEW:</strong> World bounds (bounce)</p>
  </div>

  <div class="debug-panel">
    <h3>üî¨ Debug</h3>
    <div class="debug-stat">
      <span class="label">Entities:</span>
      <span class="value" id="debug-entities">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">Fields:</span>
      <span class="value" id="debug-fields">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">Distance:</span>
      <span class="value" id="debug-dist">-</span>
    </div>
    <div class="debug-stat">
      <span class="label">Mood:</span>
      <span class="value" id="debug-mood">-</span>
    </div>
    <div class="debug-stat">
      <span class="label">Spawned:</span>
      <span class="value" id="debug-spawned">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">Destroyed:</span>
      <span class="value" id="debug-destroyed">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">FPS:</span>
      <span class="value" id="debug-fps">60</span>
    </div>
  </div>

  <div class="lifecycle-log">
    <h3>üìú Lifecycle Log (v4.2)</h3>
    <div id="log-container"></div>
  </div>

  <div class="controls">
    <button class="btn" onclick="window.saveState()">üíæ Save</button>
    <button class="btn" onclick="window.loadState()">üìÇ Load</button>
    <button class="btn" id="seed-btn" onclick="window.toggleSeed()">üé≤ Seed: Off</button>
    <button class="btn" onclick="window.clearLog()">üóëÔ∏è Clear Log</button>
  </div>

  <script type="module">
    import { Engine, loadMaterial } from '../dist/mds-core.esm.js'

    // === STATE ===
    let engine = null
    let shy = null
    let curious = null
    let ftrust = null
    let a = null
    let b = null
    let useSeed = false
    let spawnCount = 0
    let destroyCount = 0
    const logEntries = []
    const MAX_LOG = 8

    // === LIFECYCLE LOG ===
    function addLog(type, message) {
      const timestamp = new Date().toLocaleTimeString()
      logEntries.unshift({ type, message, timestamp })
      if (logEntries.length > MAX_LOG) logEntries.pop()

      const container = document.getElementById('log-container')
      container.innerHTML = logEntries
        .map(e => `<div class="log-entry ${e.type}">[${e.timestamp}] ${e.message}</div>`)
        .join('')
    }

    // === INITIALIZATION ===
    async function init() {
      // Load materials
      shy = await loadMaterial('./paper.shy.mdspec.json')
      curious = await loadMaterial('./paper.curious.mdspec.json')
      ftrust = await fetch('./field.trust.core.mdspec.json').then(r => r.json())

      // Create engine with world bounds (v4.2)
      engine = new Engine({
        worldBounds: {
          minX: 50,
          maxX: window.innerWidth - 50,
          minY: 100,
          maxY: window.innerHeight - 150
        },
        boundaryBehavior: 'bounce',
        boundaryBounceDamping: 0.8,
        seed: useSeed ? 42 : undefined
      })

      spawnEntities()
      engine.start()
      updateDebugPanel()
      monitorEmotions()
      monitorLifecycle()

      addLog('spawn', 'üåå Engine initialized with world bounds')
    }

    function spawnEntities() {
      // Spawn entities closer together
      a = engine.spawn(shy, 180, 200)
      b = engine.spawn(curious, 300, 240)

      // Give initial velocity
      a.vx = 0.5
      a.vy = 0.3
      b.vx = -0.4
      b.vy = -0.2

      // === v4.2 LIFECYCLE HOOKS ===
      a.onSpawn = (eng, entity) => {
        spawnCount++
        addLog('spawn', `üíå Shy spawned at (${Math.round(entity.x)}, ${Math.round(entity.y)})`)
      }

      a.onUpdate = (dt, entity) => {
        // Log every 5 seconds
        if (Math.floor(entity.age) % 5 === 0 && entity.age > 0.1 && !entity._lastLogAge) {
          entity._lastLogAge = Math.floor(entity.age)
          addLog('update', `üíå Shy age: ${Math.round(entity.age)}s, opacity: ${Math.round(entity.opacity * 100)}%`)
        }
        if (Math.floor(entity.age) !== entity._lastLogAge) {
          entity._lastLogAge = null
        }
      }

      a.onDestroy = (entity) => {
        destroyCount++
        addLog('destroy', `üíå Shy destroyed after ${Math.round(entity.age)}s`)
      }

      b.onSpawn = (eng, entity) => {
        spawnCount++
        addLog('spawn', `üê• Curious spawned at (${Math.round(entity.x)}, ${Math.round(entity.y)})`)
      }

      b.onUpdate = (dt, entity) => {
        if (Math.floor(entity.age) % 5 === 0 && entity.age > 0.1 && !entity._lastLogAge) {
          entity._lastLogAge = Math.floor(entity.age)
          addLog('update', `üê• Curious age: ${Math.round(entity.age)}s, opacity: ${Math.round(entity.opacity * 100)}%`)
        }
        if (Math.floor(entity.age) !== entity._lastLogAge) {
          entity._lastLogAge = null
        }
      }

      b.onDestroy = (entity) => {
        destroyCount++
        addLog('destroy', `üê• Curious destroyed after ${Math.round(entity.age)}s`)
      }

      // Trigger onSpawn manually (already spawned)
      a.onSpawn(engine, a)
      b.onSpawn(engine, b)

      // Setup proximity trigger
      let fieldSpawned = false
      a.onProximity = (eng, other, dist) => {
        if (dist < 80 && !fieldSpawned) {
          const midX = (a.x + other.x) / 2
          const midY = (a.y + other.y) / 2
          eng.spawnField(ftrust, midX, midY)
          fieldSpawned = true
          addLog('spawn', `‚ú® Trust field spawned at (${Math.round(midX)}, ${Math.round(midY)})`)
          setTimeout(() => fieldSpawned = false, 10000)
        }
      }
      b.onProximity = a.onProximity
    }

    // === v4.2 SAVE/LOAD ===
    window.saveState = () => {
      const snapshot = engine.snapshot()
      localStorage.setItem('mds-emoji-field-state', JSON.stringify(snapshot))
      addLog('spawn', 'üíæ State saved to localStorage')
      alert('‚úÖ State saved!')
    }

    window.loadState = () => {
      const data = localStorage.getItem('mds-emoji-field-state')
      if (!data) {
        alert('‚ùå No saved state found')
        return
      }

      const snapshot = JSON.parse(data)
      const materialMap = new Map([
        ['paper.shy', shy],
        ['paper.curious', curious]
      ])
      const fieldMap = new Map([
        ['field.trust.core', ftrust]
      ])

      engine.stop()
      engine.clear()
      engine.restore(snapshot, materialMap, fieldMap)
      engine.start()

      // Re-assign references
      a = engine.getEntities()[0]
      b = engine.getEntities()[1]

      // Re-attach hooks
      if (a) {
        a.onSpawn = (eng, entity) => {
          spawnCount++
          addLog('spawn', `üíå Shy restored`)
        }
        a.onDestroy = (entity) => {
          destroyCount++
          addLog('destroy', `üíå Shy destroyed after ${Math.round(entity.age)}s`)
        }
      }
      if (b) {
        b.onSpawn = (eng, entity) => {
          spawnCount++
          addLog('spawn', `üê• Curious restored`)
        }
        b.onDestroy = (entity) => {
          destroyCount++
          addLog('destroy', `üê• Curious destroyed after ${Math.round(entity.age)}s`)
        }
      }

      addLog('spawn', 'üìÇ State loaded from localStorage')
    }

    // === v4.2 SEED TOGGLE ===
    window.toggleSeed = () => {
      useSeed = !useSeed
      const btn = document.getElementById('seed-btn')
      btn.textContent = useSeed ? 'üé≤ Seed: On' : 'üé≤ Seed: Off'
      btn.classList.toggle('active', useSeed)

      // Restart engine with new seed
      engine.stop()
      engine.clear()
      logEntries.length = 0
      spawnCount = 0
      destroyCount = 0

      init()

      addLog('spawn', useSeed ? 'üé≤ Seed mode ON (seed=42)' : 'üé≤ Seed mode OFF (random)')
    }

    window.clearLog = () => {
      logEntries.length = 0
      document.getElementById('log-container').innerHTML = ''
    }

    // === DEBUG PANEL UPDATE ===
    const debugEntities = document.getElementById('debug-entities')
    const debugFields = document.getElementById('debug-fields')
    const debugDist = document.getElementById('debug-dist')
    const debugMood = document.getElementById('debug-mood')
    const debugSpawned = document.getElementById('debug-spawned')
    const debugDestroyed = document.getElementById('debug-destroyed')
    const debugFps = document.getElementById('debug-fps')

    let frameCount = 0
    let lastFpsUpdate = performance.now()

    function updateDebugPanel() {
      if (!engine) return

      debugEntities.textContent = engine.getEntities().length
      debugFields.textContent = engine.getFields().length
      debugSpawned.textContent = spawnCount
      debugDestroyed.textContent = destroyCount

      const entities = engine.getEntities()
      if (entities.length >= 2) {
        const e1 = entities[0]
        const e2 = entities[1]
        const dx = e1.x - e2.x
        const dy = e1.y - e2.y
        const dist = Math.sqrt(dx * dx + dy * dy)
        debugDist.textContent = Math.round(dist) + 'px'

        let mood = 'üòê neutral'
        if (dist < 80) mood = 'ü•∞ intimate'
        else if (dist < 120) mood = 'üòä close'
        else if (dist < 200) mood = 'üôÇ aware'
        debugMood.textContent = mood
      }

      frameCount++
      const now = performance.now()
      if (now - lastFpsUpdate >= 1000) {
        debugFps.textContent = frameCount
        frameCount = 0
        lastFpsUpdate = now
      }

      requestAnimationFrame(updateDebugPanel)
    }

    // === TEXT BUBBLE SYSTEM ===
    const selfAwareTexts = {
      intro: ['‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤...', '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏•‡∏Å‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏£‡∏≠?', '‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£?'],
      young: ['‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ {age}s', '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏µ!', '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏ï‡πá‡∏°‡∏£‡πâ‡∏≠‡∏¢!'],
      aging: ['‡∏≠‡∏≤‡∏¢‡∏∏ {age}s ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢', '‡∏â‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ... ({opacity}%)', '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {opacity}%'],
      dying: ['‡∏â‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß...', '‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢', '‡∏≠‡∏µ‡∏Å‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô‡∏â‡∏±‡∏ô‡∏Å‡πá‡∏´‡∏≤‡∏¢‡πÑ‡∏õ'],
      curious: ['‡πÄ‡∏ò‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£?', '‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°?', '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏≤ {dist}px'],
      close: ['‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ... ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô', '‡∏â‡∏±‡∏ô‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ò‡∏≠', '‡πÄ‡∏£‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å {dist}px'],
      intimate: ['‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?', '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏±‡∏ô', '‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô'],
      lonely: ['‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏á‡∏≤‡∏à‡∏±‡∏á', '‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?', '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á {dist}px ‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ']
    }

    let lastDist = 999
    let lastBubbleTime = 0

    function spawnBubble(entity, textType) {
      const now = performance.now()
      if (now - lastBubbleTime < 2000) return
      lastBubbleTime = now

      const texts = selfAwareTexts[textType] || selfAwareTexts.intro
      let text = texts[Math.floor(Math.random() * texts.length)]

      const age = Math.round(entity.age)
      const opacity = Math.round(entity.opacity * 100)
      const dist = Math.round(lastDist)

      text = text.replace('{age}', age).replace('{opacity}', opacity).replace('{dist}', dist)

      const bubble = document.createElement('div')
      bubble.className = 'emoji-bubble'
      bubble.textContent = text
      bubble.style.left = entity.x + 'px'
      bubble.style.top = (entity.y - 20) + 'px'
      document.body.appendChild(bubble)

      setTimeout(() => bubble.remove(), 3000)
    }

    function monitorEmotions() {
      if (!engine) return

      const entities = engine.getEntities()
      if (entities.length >= 2) {
        const e1 = entities[0]
        const e2 = entities[1]
        const dx = e1.x - e2.x
        const dy = e1.y - e2.y
        const dist = Math.sqrt(dx * dx + dy * dy)

        if (dist < lastDist && dist < 150 && lastDist > 150) {
          spawnBubble(e2, 'curious')
        }
        if (dist < 100 && lastDist >= 100) {
          setTimeout(() => spawnBubble(e1, 'close'), 500)
        }
        if (dist < 80 && lastDist >= 80) {
          setTimeout(() => spawnBubble(e2, 'intimate'), 800)
        }
        if (dist > lastDist && dist > 150 && lastDist <= 150) {
          spawnBubble(e1, 'lonely')
        }

        lastDist = dist
      }

      setTimeout(monitorEmotions, 500)
    }

    function monitorLifecycle() {
      if (!engine) return

      for (const entity of engine.getEntities()) {
        const age = entity.age
        const opacity = entity.opacity

        if (age < 2 && !entity._spokenIntro) {
          setTimeout(() => spawnBubble(entity, 'intro'), 1000)
          entity._spokenIntro = true
        }
        if (age >= 3 && age < 10 && !entity._spokenYoung) {
          setTimeout(() => spawnBubble(entity, 'young'), Math.random() * 2000)
          entity._spokenYoung = true
        }
        if (opacity < 0.7 && opacity > 0.4 && !entity._spokenAging) {
          setTimeout(() => spawnBubble(entity, 'aging'), Math.random() * 1000)
          entity._spokenAging = true
        }
        if (opacity < 0.4 && !entity._spokenDying) {
          setTimeout(() => spawnBubble(entity, 'dying'), 500)
          entity._spokenDying = true
        }
      }

      setTimeout(monitorLifecycle, 1000)
    }

    // Start
    init()

    console.log('üåå MDS v4.2 - Info-Physics Engine with Lifecycle Hooks Started')
    console.log('Try: window.saveState(), window.loadState(), window.toggleSeed()')
  </script>
</body>
</html>
