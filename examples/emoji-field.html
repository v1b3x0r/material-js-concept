<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MDS v4.0 - Emoji Field Demo</title>
  <style>
    body {
      margin: 0;
      height: 100vh;
      background: #0e0f12;
      color: #eee;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .mds-entity {
      position: absolute;
      font-size: 40px;
      user-select: none;
      will-change: transform, opacity, filter;
      transition: filter 0.2s ease;
      cursor: pointer;
    }

    .mds-field {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(
        circle,
        rgba(255, 200, 100, 0.2) 0%,
        rgba(255, 200, 100, 0.05) 50%,
        transparent 100%
      );
      pointer-events: none;
      animation: field-pulse 2s ease-in-out infinite;
    }

    @keyframes field-pulse {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.05); }
    }

    .info {
      position: fixed;
      top: 20px;
      left: 20px;
      font-size: 14px;
      line-height: 1.6;
      background: rgba(0, 0, 0, 0.5);
      padding: 16px;
      border-radius: 8px;
      max-width: 320px;
    }

    .info h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #ffdc78;
    }

    .info p {
      margin: 8px 0;
      color: #ccc;
    }

    .info code {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
    }

    .debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.7);
      padding: 16px;
      border-radius: 8px;
      font-size: 12px;
      min-width: 180px;
      backdrop-filter: blur(8px);
    }

    .debug-panel h3 {
      margin: 0 0 12px;
      font-size: 14px;
      color: #ffdc78;
    }

    .debug-stat {
      display: flex;
      justify-content: space-between;
      margin: 6px 0;
      color: #ccc;
    }

    .debug-stat .label {
      color: #999;
    }

    .debug-stat .value {
      color: #6cf;
      font-weight: 600;
    }

    .emoji-bubble {
      position: absolute;
      pointer-events: none;
      animation: bubble-float 3s ease-out forwards;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      padding: 8px 14px;
      border-radius: 16px;
      font-size: 13px;
      white-space: nowrap;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(8px);
      max-width: 200px;
      text-align: center;
    }

    @keyframes bubble-float {
      0% {
        opacity: 0;
        transform: translateY(0) translateX(-50%) scale(0.8);
      }
      10% {
        opacity: 1;
        transform: translateY(-8px) translateX(-50%) scale(1.02);
      }
      80% {
        opacity: 1;
        transform: translateY(-35px) translateX(-50%) scale(1);
      }
      100% {
        opacity: 0;
        transform: translateY(-50px) translateX(-50%) scale(0.9);
      }
    }
  </style>
</head>
<body>
  <div class="info">
    <h2>üåå MDS v4.0 Demo A</h2>
    <p><strong>Emoji Field Interaction</strong></p>
    <p>üíå Shy paper - Hover 3 times to make it slide away</p>
    <p>üê• Curious paper - Leans in when hovered</p>
    <p>‚ú® When they get close (&lt;80px), a trust field spawns</p>
    <p>‚è±Ô∏è Papers fade naturally over time (decay rate)</p>
  </div>

  <div class="debug-panel">
    <h3>üî¨ Debug</h3>
    <div class="debug-stat">
      <span class="label">Entities:</span>
      <span class="value" id="debug-entities">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">Fields:</span>
      <span class="value" id="debug-fields">0</span>
    </div>
    <div class="debug-stat">
      <span class="label">Distance:</span>
      <span class="value" id="debug-dist">-</span>
    </div>
    <div class="debug-stat">
      <span class="label">Mood:</span>
      <span class="value" id="debug-mood">-</span>
    </div>
    <div class="debug-stat">
      <span class="label">FPS:</span>
      <span class="value" id="debug-fps">60</span>
    </div>
  </div>

  <script type="module">
    import { Engine, loadMaterial } from '../dist/mds-core.esm.js'

    // Initialize engine
    const engine = new Engine()

    // Load materials
    const shy = await loadMaterial('./paper.shy.mdspec.json')
    const curious = await loadMaterial('./paper.curious.mdspec.json')
    const ftrust = await fetch('./field.trust.core.mdspec.json').then(r => r.json())

    // Spawn entities closer together so they feel attraction forces
    const a = engine.spawn(shy, 180, 200)
    const b = engine.spawn(curious, 300, 240)

    // Give them initial velocity for more dynamic movement
    a.vx = 0.5
    a.vy = 0.3
    b.vx = -0.4
    b.vy = -0.2

    // Setup proximity trigger for field spawning
    let fieldSpawned = false
    a.onProximity = (eng, other, dist) => {
      if (dist < 80 && !fieldSpawned) {
        const midX = (a.x + other.x) / 2
        const midY = (a.y + other.y) / 2
        eng.spawnField(ftrust, midX, midY)
        fieldSpawned = true
        // Allow spawning again after 10 seconds
        setTimeout(() => fieldSpawned = false, 10000)
      }
    }
    b.onProximity = a.onProximity

    // Start simulation
    engine.start()

    // === DEBUG PANEL UPDATE ===
    const debugEntities = document.getElementById('debug-entities')
    const debugFields = document.getElementById('debug-fields')
    const debugDist = document.getElementById('debug-dist')
    const debugMood = document.getElementById('debug-mood')
    const debugFps = document.getElementById('debug-fps')

    let frameCount = 0
    let lastFpsUpdate = performance.now()

    function updateDebugPanel() {
      debugEntities.textContent = engine.entities.length
      debugFields.textContent = engine.fields.length

      // Calculate distance between entities
      if (engine.entities.length >= 2) {
        const dx = a.x - b.x
        const dy = a.y - b.y
        const dist = Math.sqrt(dx * dx + dy * dy)
        debugDist.textContent = Math.round(dist) + 'px'

        // Determine mood based on distance and entropy
        let mood = 'üòê neutral'
        if (dist < 80) mood = 'ü•∞ intimate'
        else if (dist < 120) mood = 'üòä close'
        else if (dist < 200) mood = 'üôÇ aware'
        debugMood.textContent = mood
      }

      // FPS counter
      frameCount++
      const now = performance.now()
      if (now - lastFpsUpdate >= 1000) {
        debugFps.textContent = frameCount
        frameCount = 0
        lastFpsUpdate = now
      }

      requestAnimationFrame(updateDebugPanel)
    }
    updateDebugPanel()

    // === TEXT BUBBLE SYSTEM ===
    const selfAwareTexts = {
      intro: [
        '‡∏â‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏Å‡∏¥‡∏î‡∏°‡∏≤...',
        '‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏•‡∏Å‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏´‡∏£‡∏≠?',
        '‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‡πÉ‡∏Ñ‡∏£?'
      ],
      young: [
        '‡∏â‡∏±‡∏ô‡∏¢‡∏±‡∏á‡πÄ‡∏î‡πá‡∏Å‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞ ‡∏≠‡∏≤‡∏¢‡∏∏ {age}s',
        '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏î‡∏µ!',
        '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏ï‡πá‡∏°‡∏£‡πâ‡∏≠‡∏¢!'
      ],
      aging: [
        '‡∏≠‡∏≤‡∏¢‡∏∏ {age}s ‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢',
        '‡∏â‡∏±‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏á‡∏´‡∏≤‡∏¢‡πÑ‡∏õ... ({opacity}%)',
        '‡∏û‡∏•‡∏±‡∏á‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡πÄ‡∏´‡∏•‡∏∑‡∏≠ {opacity}%'
      ],
      dying: [
        '‡∏â‡∏±‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡∏ï‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß...',
        '‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢',
        '‡∏≠‡∏µ‡∏Å‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô‡∏â‡∏±‡∏ô‡∏Å‡πá‡∏´‡∏≤‡∏¢‡πÑ‡∏õ'
      ],
      curious: [
        '‡πÄ‡∏ò‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏Ñ‡∏£?',
        '‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ô‡πÑ‡∏´‡∏°?',
        '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡πÄ‡∏£‡∏≤ {dist}px'
      ],
      close: [
        '‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ... ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô',
        '‡∏â‡∏±‡∏ô‡∏ä‡∏≠‡∏ö‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏ò‡∏≠',
        '‡πÄ‡∏£‡∏≤‡πÉ‡∏Å‡∏•‡πâ‡∏Å‡∏±‡∏ô‡∏°‡∏≤‡∏Å {dist}px'
      ],
      intimate: [
        '‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?',
        '‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Å‡∏±‡∏ô',
        '‡∏û‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏ò‡∏≠‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏â‡∏±‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô'
      ],
      lonely: [
        '‡∏≠‡∏¢‡∏π‡πà‡∏Ñ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏á‡∏≤‡∏à‡∏±‡∏á',
        '‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏°?',
        '‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á {dist}px ‡πÑ‡∏Å‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ'
      ]
    }

    let lastDist = 999
    let bubbleTimeout = null
    let lastBubbleTime = 0

    function spawnBubble(entity, textType) {
      // Throttle bubbles (max 1 per 2 seconds)
      const now = performance.now()
      if (now - lastBubbleTime < 2000) return
      lastBubbleTime = now

      const texts = selfAwareTexts[textType] || selfAwareTexts.intro
      let text = texts[Math.floor(Math.random() * texts.length)]

      // Replace placeholders
      const age = Math.round(entity.age)
      const opacity = Math.round(entity.opacity * 100)
      const dist = Math.round(lastDist)

      text = text
        .replace('{age}', age)
        .replace('{opacity}', opacity)
        .replace('{dist}', dist)

      const bubble = document.createElement('div')
      bubble.className = 'emoji-bubble'
      bubble.textContent = text
      bubble.style.left = entity.x + 'px'
      bubble.style.top = (entity.y - 20) + 'px'
      document.body.appendChild(bubble)

      setTimeout(() => bubble.remove(), 3000)
    }

    // Monitor distance changes for emotion triggers
    function monitorEmotions() {
      if (engine.entities.length >= 2) {
        const dx = a.x - b.x
        const dy = a.y - b.y
        const dist = Math.sqrt(dx * dx + dy * dy)

        // Approaching
        if (dist < lastDist && dist < 150 && lastDist > 150) {
          spawnBubble(b, 'curious')
        }

        // Getting close
        if (dist < 100 && lastDist >= 100) {
          setTimeout(() => spawnBubble(a, 'close'), 500)
        }

        // Very close (intimate)
        if (dist < 80 && lastDist >= 80) {
          setTimeout(() => spawnBubble(b, 'intimate'), 800)
        }

        // Moving apart
        if (dist > lastDist && dist > 150 && lastDist <= 150) {
          spawnBubble(a, 'lonely')
        }

        lastDist = dist
      }

      setTimeout(monitorEmotions, 500)
    }
    monitorEmotions()

    // Monitor entity lifecycle for self-aware messages
    function monitorLifecycle() {
      for (const entity of engine.entities) {
        const age = entity.age
        const opacity = entity.opacity

        // Intro (first 2 seconds)
        if (age < 2 && !entity._spokenIntro) {
          setTimeout(() => spawnBubble(entity, 'intro'), 1000)
          entity._spokenIntro = true
        }

        // Young (2-10 seconds)
        if (age >= 3 && age < 10 && !entity._spokenYoung) {
          setTimeout(() => spawnBubble(entity, 'young'), Math.random() * 2000)
          entity._spokenYoung = true
        }

        // Aging (opacity < 70%)
        if (opacity < 0.7 && opacity > 0.4 && !entity._spokenAging) {
          setTimeout(() => spawnBubble(entity, 'aging'), Math.random() * 1000)
          entity._spokenAging = true
        }

        // Dying (opacity < 40%)
        if (opacity < 0.4 && !entity._spokenDying) {
          setTimeout(() => spawnBubble(entity, 'dying'), 500)
          entity._spokenDying = true
        }
      }

      setTimeout(monitorLifecycle, 1000)
    }
    monitorLifecycle()

    console.log('üåå MDS v4.0 - Info-Physics Engine Started')
    console.log('Materials are alive. Watch them age, interact, and spawn fields.')
  </script>
</body>
</html>
